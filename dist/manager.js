'use strict';

var managerApi = require('@storybook/manager-api');
var a = require('react');
var theming = require('@storybook/theming');
var yup = require('yup');
var supabaseJs = require('@supabase/supabase-js');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var a__default = /*#__PURE__*/_interopDefault(a);

var b="storybook/discussion",V=`${b}/tab`,$="discussion";var N=theming.styled.span(({theme:t})=>({display:"grid",flexDirection:"column",margin:0,padding:"0.5rem",borderRadius:t.appBorderRadius,backgroundColor:t.background.app,color:t.color.primary})),R=theming.styled.span({paddingInlineStart:"1rem",margin:"1rem 0",display:"block"}),Y=theming.styled.small({textAlign:"end"});function E(t){let{comment:r}=t,{author:e,comment:o,createdAt:m}=r;return a__default.default.createElement(N,null,a__default.default.createElement("strong",null,e),a__default.default.createElement(R,null,a__default.default.createElement("em",null,o)),a__default.default.createElement(Y,null,m))}var j=theming.styled.ul({margin:0,padding:0,listStyle:"none"}),K=theming.styled.li({marginBottom:"0.5rem"});function k(t){let{comments:r}=t;return a__default.default.createElement(j,null,r.map(e=>a__default.default.createElement(K,{key:e.id},a__default.default.createElement(E,{comment:e}))))}var ht=theming.keyframes`
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
`,It=theming.styled.div(({theme:t})=>({display:"inline-block",width:"80px",height:"80px",":after":{content:'" "',display:"block",width:"64px",height:"64px",margin:"8px",borderRadius:"50%",border:`6px solid ${t.color.primary}`,borderColor:`${t.color.primary} transparent ${t.color.primary} transparent`,animation:`${ht} 1.2s linear infinite`}}));function M(){return a__default.default.createElement(It,null)}function U(){return a__default.default.createElement("svg",{version:"1.0",xmlns:"http://www.w3.org/2000/svg",width:"128.000000pt",height:"128.000000pt",viewBox:"0 0 128.000000 128.000000",preserveAspectRatio:"xMidYMid meet"},a__default.default.createElement("g",{transform:"translate(0.000000,128.000000) scale(0.100000,-0.100000)",fill:"#000000",stroke:"none"},a__default.default.createElement("path",{d:`M523 1260 c-56 -34 -63 -60 -63 -240 l0 -160 -24 0 c-26 0 -51 -24
   -41 -40 4 -6 63 -10 156 -10 156 0 199 -9 213 -45 3 -9 6 -115 6 -235 0 -282
   12 -263 -177 -270 l-139 -5 -52 -37 c-29 -21 -56 -38 -60 -38 -5 0 -14 18 -21
   40 l-12 40 -95 0 c-99 0 -146 13 -158 45 -12 32 -6 449 7 466 20 26 53 39 101
   39 49 0 65 12 45 37 -17 20 -115 13 -152 -12 -51 -33 -57 -64 -57 -299 0 -302
   8 -317 178 -326 l94 -5 18 -45 c20 -51 32 -58 65 -36 23 15 27 15 52 -1 21
   -14 56 -19 157 -23 l131 -5 70 -49 c78 -55 91 -54 112 11 l14 41 93 4 c101 4
   131 16 163 65 16 23 18 56 21 247 l2 220 28 12 c15 6 38 24 52 39 25 27 25 27
   28 260 3 260 0 278 -61 315 -30 19 -52 20 -347 20 -295 0 -317 -1 -347 -20z
   m661 -41 c43 -20 47 -50 44 -277 -4 -260 5 -245 -146 -252 l-107 -5 -19 -42
   -19 -42 -58 42 c-50 35 -59 46 -59 71 l0 31 52 -3 c106 -6 215 82 233 188 16
   93 -43 202 -129 241 -50 23 -134 24 -184 3 -103 -43 -161 -162 -129 -266 l15
   -48 -84 0 -84 0 1 153 c0 83 4 160 8 171 16 42 41 45 348 46 196 0 300 -4 317
   -11z m-228 -98 c56 -25 87 -71 92 -138 5 -64 -9 -103 -54 -143 -67 -58 -157
   -60 -224 -4 -42 36 -60 75 -60 131 0 66 33 120 89 150 53 28 102 29 157 4z
   m154 -709 c0 -269 8 -255 -147 -260 l-105 -4 -15 -37 c-8 -20 -17 -38 -19 -40
   -2 -2 -27 14 -56 35 l-53 39 -137 5 c-75 3 -140 8 -144 12 -4 4 4 16 17 27 21
   18 39 20 142 21 136 0 176 12 207 62 18 29 20 50 20 186 0 83 2 152 6 152 3 0
   32 -18 64 -40 66 -45 78 -48 87 -22 29 82 29 82 82 82 l51 0 0 -218z`}),a__default.default.createElement("path",{d:"M804 1026 c-10 -26 0 -51 21 -51 16 0 20 7 20 30 0 33 -30 49 -41 21z"}),a__default.default.createElement("path",{d:"M914 1026 c-10 -26 0 -51 21 -51 16 0 20 7 20 30 0 33 -30 49 -41 21z"}),a__default.default.createElement("path",{d:`M813 913 c-8 -21 31 -53 66 -53 15 0 37 7 49 16 41 29 20 67 -25 43
   -19 -10 -28 -10 -43 -1 -27 16 -39 15 -47 -5z`}),a__default.default.createElement("path",{d:`M290 850 c-18 -11 -4 -42 17 -38 10 2 19 10 21 19 4 19 -19 31 -38
   19z`}),a__default.default.createElement("path",{d:`M249 703 c-114 -71 -52 -259 113 -344 50 -26 61 -24 121 14 124 80
   178 198 132 287 -29 56 -113 77 -175 45 -27 -14 -33 -14 -60 0 -38 20 -98 19
   -131 -2z m125 -58 l36 -24 36 24 c48 33 87 32 113 -1 46 -58 7 -150 -91 -217
   l-56 -39 -39 25 c-116 74 -164 177 -108 232 31 32 63 32 109 0z`})))}function Q(){return a__default.default.createElement("svg",{version:"1.0",xmlns:"http://www.w3.org/2000/svg",width:"128.000000pt",height:"128.000000pt",viewBox:"0 0 128.000000 128.000000",preserveAspectRatio:"xMidYMid meet"},a__default.default.createElement("g",{transform:"translate(0.000000,128.000000) scale(0.100000,-0.100000)",fill:"#000000",stroke:"none"},a__default.default.createElement("path",{d:`M643 1230 c-78 -18 -93 -54 -93 -226 0 -126 -1 -136 -17 -129 -10 5
   -58 10 -108 12 -75 4 -100 1 -146 -16 -121 -46 -206 -127 -250 -238 -41 -104
   -27 -313 21 -313 24 0 24 -1 4 61 -56 169 51 384 223 449 67 26 177 31 236 11
   l37 -13 0 -114 c0 -175 22 -204 154 -204 l79 0 -5 -63 c-17 -212 -217 -362
   -435 -327 -66 10 -77 9 -154 -14 -46 -14 -85 -24 -87 -21 -2 2 5 34 16 71 21
   69 19 87 -13 114 -25 21 -42 -3 -23 -31 13 -20 12 -30 -6 -90 -30 -104 -7
   -118 126 -78 59 17 81 19 140 11 140 -18 262 21 354 113 29 28 61 70 73 93 26
   50 51 144 51 189 l0 33 73 0 72 0 75 -80 c74 -78 91 -89 118 -71 15 9 31 70
   32 117 0 23 6 34 25 42 14 6 34 26 45 44 19 31 20 51 20 308 0 255 -2 277 -20
   307 -22 37 -41 48 -95 57 -45 7 -71 -4 -62 -28 4 -11 19 -16 46 -16 23 0 48
   -8 62 -19 24 -19 24 -19 27 -283 2 -164 -1 -275 -7 -291 -6 -15 -23 -33 -38
   -39 -38 -17 -40 -20 -48 -101 l-7 -72 -76 83 -77 83 -157 -1 c-151 0 -157 1
   -172 22 -24 33 -24 563 0 596 15 21 20 22 200 22 160 0 185 2 191 16 3 9 0 20
   -8 25 -17 11 -351 10 -396 -1z`}),a__default.default.createElement("path",{d:`M884 1150 c-46 -19 -54 -46 -54 -183 0 -122 1 -129 25 -152 16 -17
   35 -25 60 -25 25 0 44 8 60 25 24 23 25 29 25 154 0 121 -2 132 -22 155 -26
   29 -63 39 -94 26z m64 -52 c15 -15 16 -221 2 -249 -12 -21 -50 -25 -68 -7 -17
   17 -17 239 0 256 7 7 21 12 33 12 12 0 26 -5 33 -12z`}),a__default.default.createElement("path",{d:`M875 758 c-50 -29 -60 -89 -22 -133 50 -58 147 -20 147 58 -1 66 -69
   107 -125 75z m67 -45 c32 -29 16 -73 -27 -73 -42 0 -59 44 -29 74 20 20 33 20
   56 -1z`}),a__default.default.createElement("path",{d:`M190 403 c-51 -65 36 -149 98 -95 32 26 37 63 12 95 -30 37 -80 37
   -110 0z`}),a__default.default.createElement("path",{d:`M360 410 c-27 -27 -26 -71 3 -98 30 -28 68 -28 95 1 44 46 14 117
   -48 117 -17 0 -39 -9 -50 -20z`}),a__default.default.createElement("path",{d:`M521 404 c-27 -35 -26 -59 4 -89 45 -46 118 -19 118 43 0 69 -80 99
   -122 46z`})))}var X=theming.styled.div({textAlign:"center"}),q=theming.styled.section(({theme:t})=>({textAlign:"center",color:t.color.negative}));function _(t){let{isLoading:r,error:e,comments:o}=t;return r?a__default.default.createElement(X,null,a__default.default.createElement(M,null)):!r&&e?a__default.default.createElement(q,null,a__default.default.createElement(Q,null),a__default.default.createElement("h3",null,"Something went wrong, while loading comments!")):!r&&o.length===0?a__default.default.createElement(q,null,a__default.default.createElement(U,null),a__default.default.createElement("h3",null,"No one has written his comment yet! Be the first one!")):a__default.default.createElement(k,{comments:o})}var Z=theming.styled.p(({theme:t})=>({margin:0,label:{display:"block",margin:"0.25rem"},span:{display:"block",color:t.color.warningText}}));function v(t){let{name:r,label:e,children:o,error:m}=t;return a__default.default.createElement(Z,null,a__default.default.createElement("label",{htmlFor:r},a__default.default.createElement("b",null,e)),a__default.default.cloneElement(o,{name:r}),m?a__default.default.createElement("span",null,m):null)}var F=theming.styled.input(({theme:t})=>({border:t.input.border,borderRadius:t.input.borderRadius,background:t.input.background,color:t.input.color,height:"32px",width:"100%",padding:"5px"}));var L=theming.styled.textarea(({theme:t})=>({border:t.input.border,borderRadius:t.input.borderRadius,background:t.input.background,color:t.input.color,borderColor:"#3F4242",width:"100%",padding:"5px"}));var f=class{constructor(){}static getDBInstance(r,e){return f.dbInstance||(f.dbInstance=supabaseJs.createClient(r,e)),f.dbInstance}};var D=class{constructor(r,e){this.db=f.getDBInstance(r,e);}async insert(r){return await this.db.from("comments_v1").insert(r).select("*").limit(1).single()}async update(r){return await this.db.from("comments_v1").update(r).eq("id",r.id).select("*").limit(1).single()}async delete(r){return await this.db.from("comments_v1").delete().eq("id",r)}async getBy(r,e){return await this.db.from("comments_v1").select("*").eq(r,e)}async getAll(){return await this.db.from("comments_v1").select("*")}};var g=class{constructor(r,e){this.data=new D(r,e);}async insert(r){return await this.data.insert({author:r.author,comment:r.comment,createdat:r.createdAt,storyid:r.storyId})}async update(r){return await this.data.update(r)}async delete(r){return await this.data.delete(r)}async getBy(r,e){return await this.data.getBy(r,e)}async getAll(){return await this.data.getAll()}};function rt(t){let r=a.useMemo(()=>new g(t.supabase.url,t.supabase.secret),[]),[e,o]=a.useState(!1),[m,c]=a.useState(null);return {isLoading:e,error:m,saveComment:async C=>{o(!0);let s=await r.insert(C);return s.error&&c(s.error),o(!1),s}}}function et(t){return new Intl.DateTimeFormat("en-GB",{dateStyle:"medium",timeStyle:"short"}).format(new Date(t))}function w(t){return {id:t.id,author:t.author,storyId:t.storyid,comment:t.comment,createdAt:et(t.createdat)}}var At=yup.object().shape({author:yup.string().required("Required"),comment:yup.string().required("Required"),storyId:yup.string().required(),createdAt:yup.string().required()});function ot(t){return At.validate(t)}var mt=theming.styled.form(({theme:t})=>({padding:"0.5rem",borderRadius:t.appBorderRadius,backgroundColor:t.background.app,color:t.color.primary,h3:{margin:0,marginBottom:"0.5rem"},">p":{marginBottom:"0.5rem"}})),st=theming.styled.section(({theme:t})=>({display:"flex",justifyContent:"flex-end",gap:"0.5rem",alignItems:"center","input[type=submit]":{cursor:"pointer",outline:0,padding:"5px 16px",border:t.input.border,borderRadius:t.input.borderRadius,color:"#ffffff",backgroundColor:"#2ea44f",":hover":{backgroundColor:"#2c974b",transitionDuration:"0.1s"}},"input[type=reset]":{cursor:"pointer",outline:0,padding:"5px 16px",border:t.input.border,borderRadius:t.input.borderRadius,color:"#24292e",backgroundColor:"#fafbfc",":hover":{backgroundColor:"#f3f4f6",transitionDuration:"0.1s"}}}));function z(t){let{storyId:r,setComment:e,paramData:o}=t,m=a.useRef(null),{isLoading:c,error:l,saveComment:C}=rt(o),[s,n]=a.useState({});return a.useEffect(()=>{l&&alert(l?.message);},[l]),a__default.default.createElement(mt,{onSubmit:async S=>{S.preventDefault();let{elements:i}=S.currentTarget,x=i.namedItem("author").value,ft=i.namedItem("comment").value,H={author:x.trim(),comment:ft.trim(),storyId:r,createdAt:new Date().toISOString()};try{await ot(H);let h=await C(H);h.data&&(e(w(h.data)),m.current.reset(),m.current.scrollIntoView({behavior:"instant"}));}catch(h){if(h instanceof yup.ValidationError){let{path:Ct,message:bt}=h;n({[Ct]:bt});}}},ref:m},a__default.default.createElement("h3",null,"Write your feedback / comment / question"),a__default.default.createElement("hr",null),a__default.default.createElement(v,{name:"author",label:"Author",error:s.author},a__default.default.createElement(F,{type:"text",required:!0,"aria-label":"Author Name"})),a__default.default.createElement(v,{name:"comment",label:"Comment",error:s.comment},a__default.default.createElement(L,{rows:4,required:!0,"aria-label":"Comment"})),a__default.default.createElement(st,null,a__default.default.createElement("input",{type:"reset",value:"Reset",disabled:c}),a__default.default.createElement("input",{type:"submit",value:"Submit",disabled:c})))}function it(t,r){let e=a.useMemo(()=>new g(r.supabase.url,r.supabase.secret),[]),[o,m]=a.useState(!0),[c,l]=a.useState(null),[C,s]=a.useState([]);a.useEffect(()=>{G();},[]);let n=i=>i?i.map(x=>w(x)):[],G=async()=>{let i=await e.getBy("storyid",t);i.error?l(i.error):s(n(i.data)),m(!1);};return {isLoading:o,error:c,comments:C,setComment:async i=>{s(x=>[...x,i]);}}}var pt=theming.styled.div(({theme:t})=>({background:t.background.content,padding:"4rem 20px",minHeight:"100vh",boxSizing:"border-box",position:"relative"})),ct=theming.styled.div({maxWidth:768,marginLeft:"auto",marginRight:"auto"});var lt=({storyId:t,paramData:r})=>{let{isLoading:e,error:o,comments:m,setComment:c}=it(t,r),l=n=>!!(n.tagName==="DIV"&&n.hasAttribute("hidden")),C=n=>n.hasAttribute("role")&&n.getAttribute("role")==="main",s=a.useRef(null);return a.useEffect(()=>{setTimeout(()=>{let n=s.current;for(;!C(n);){if(l(n)){n.removeAttribute("hidden");break}n=n.parentElement;}},10);},[]),a__default.default.createElement(pt,{ref:s},a__default.default.createElement(ct,null,a__default.default.createElement(_,{isLoading:e,error:o,comments:m}),a__default.default.createElement("br",null),a__default.default.createElement("hr",null),a__default.default.createElement(z,{storyId:t,setComment:n=>c(n),paramData:r})))};var ut=({active:t})=>{let r=managerApi.useStorybookState(),e=managerApi.useParameter($,null),{storyId:o}=r;return t&&e?a__default.default.createElement(lt,{storyId:o,paramData:e}):null};managerApi.addons.register(b,()=>{managerApi.addons.add(V,{type:managerApi.types.TAB,title:"Discussion",route:({storyId:t})=>`/discussion/${t}`,match:({viewMode:t})=>t==="discussion",render:ut});});
//# sourceMappingURL=out.js.map
//# sourceMappingURL=manager.js.map